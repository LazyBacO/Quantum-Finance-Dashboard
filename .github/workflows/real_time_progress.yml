name: Real-time progress

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

permissions:
  contents: write
  issues: write

env:
  OPENNOVA_ISSUE_NUMBER: ${{ vars.OPENNOVA_ISSUE_NUMBER || secrets.OPENNOVA_ISSUE_NUMBER }}

jobs:
  progress:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Collect workflow statuses
        id: workflow_statuses
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const latestCommit = await github.rest.repos.getCommit({ owner, repo, ref: 'main' });
            const workflows = await github.rest.actions.listRepoWorkflows({ owner, repo });
            const byName = Object.fromEntries(workflows.data.workflows.map((wf) => [wf.name, wf.id]));

            async function latestConclusion(workflowName) {
              const workflow_id = byName[workflowName];
              if (!workflow_id) return 'unknown';

              const runs = await github.rest.actions.listWorkflowRuns({
                owner,
                repo,
                workflow_id,
                branch: 'main',
                per_page: 1,
              });

              const run = runs.data.workflow_runs[0];
              return run?.conclusion || run?.status || 'unknown';
            }

            const ciStatus = await latestConclusion('CI');
            const e2eStatus = await latestConclusion('E2E');

            let acSummary = 'unknown';
            if (e2eStatus === 'success') acSummary = 'AC-01 PASS, AC-02 PASS';
            if (['failure', 'cancelled', 'timed_out'].includes(e2eStatus)) acSummary = 'At least one AC failed';

            core.setOutput('latest_commit', `${latestCommit.data.sha.slice(0, 7)} - ${latestCommit.data.commit.message.split('\n')[0]}`);
            core.setOutput('ci_status', ciStatus);
            core.setOutput('e2e_status', e2eStatus);
            core.setOutput('ac_summary', acSummary);

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Generate progress summary
        env:
          LATEST_COMMIT: ${{ steps.workflow_statuses.outputs.latest_commit }}
          CI_STATUS: ${{ steps.workflow_statuses.outputs.ci_status }}
          E2E_STATUS: ${{ steps.workflow_statuses.outputs.e2e_status }}
          AC_SUMMARY: ${{ steps.workflow_statuses.outputs.ac_summary }}
        run: node .github/scripts/real_time_progress_generator.js

      - name: Append QA history
        env:
          CI_STATUS: ${{ steps.workflow_statuses.outputs.ci_status }}
          E2E_STATUS: ${{ steps.workflow_statuses.outputs.e2e_status }}
        run: |
          node -e "const fs=require('fs'); const path='docs/history/history.json'; const current=fs.existsSync(path)?JSON.parse(fs.readFileSync(path,'utf8')):[]; current.push({date:new Date().toISOString(),ci:process.env.CI_STATUS||'unknown',e2e:process.env.E2E_STATUS||'unknown'}); fs.writeFileSync(path, JSON.stringify(current.slice(-200), null, 2)+'\n');"

      - name: Commit history updates
        if: github.ref == 'refs/heads/main'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add docs/history/history.json progress_summary.txt
          git diff --cached --quiet || git commit -m "chore(ci): update QA history and progress summary"
          git push

      - name: Comment progress on issue
        if: env.OPENNOVA_ISSUE_NUMBER != ''
        uses: peter-evans/create-or-update-comment@v5
        with:
          issue-number: ${{ env.OPENNOVA_ISSUE_NUMBER }}
          body-path: progress_summary.txt
